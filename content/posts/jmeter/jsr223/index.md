---
title: Jmeter ç”¨è„šæœ¬å¤„ç†å™¨å¯¹æ•°æ®è¿›è¡Œå¤„ç†
description: ç”¨groovyè„šæœ¬å¤„ç†æ•°æ®
date: 2021-03-04T16:06:29+08:00
tags:
  - Jmeter
  - æµ‹è¯•è„šæœ¬
categories:
  - Test
image:
---

> å‰ä¸¤å¤©åœ¨é¡¹ç›®ä¸­å†™ jmeter æµ‹è¯•è„šæœ¬ï¼Œé¡¹ç›®ä¸­å”¯ä¸€ ID å¾—è°ƒç”¨ç«¯è¯·æ±‚æ—¶ç”Ÿæˆå¹¶ä¼ é€ï¼Œäºæ˜¯æŸ¥èµ„æ–™ã€ç¿»å®˜ç½‘æ–‡æ¡£ï¼Œç»ˆäºå†™å‡ºæ¥äº†ã€‚

> ç¤ºä¾‹ä¸­æˆ‘ä»¬ä½¿ç”¨ç®€å•çš„ç™¾åº¦ç¿»è¯‘çš„è¯å…¸ API è¯·æ±‚ json æ•°æ®ã€‚

è¯´æ˜ä¸‹ï¼Œè¿™é‡Œä¸ºå•¥è¦ç”¨ groovy è„šæœ¬ï¼Œå› ä¸ºå®˜ç½‘è¯´ groovy è„šæœ¬ä¼šç¼“å­˜ç¼–è¯‘ç»“æœï¼Œå¯æé«˜æ€§èƒ½ã€‚è€Œä¸” groovy è„šæœ¬åŸºæœ¬è·Ÿ Java æ²¡å•¥åŒºåˆ«

### é¦–å…ˆå…ˆåˆ›å»ºä¸ªç®€å•çš„ HTTP è¯·æ±‚

- æ‰“å¼€ jmeter åï¼Œå…ˆåœ¨æ ¹èŠ‚ç‚¹(Test Plan)ä¸‹æ–°å»ºä¸ªçº¿ç¨‹ç»„(Thread Group)ï¼Œé»˜è®¤çš„çº¿ç¨‹ç»„é…ç½®å°±å¤Ÿæˆ‘ä»¬æœ¬æ¬¡ç¤ºä¾‹ç”¨äº†
- åœ¨çº¿ç¨‹ç»„ä¸‹æ–°å»ºä¸ª Http è¯·æ±‚(HTTP Request)ï¼Œå†æ–°å»ºä¸ªç»“æœæ ‘å±•ç¤º(View Results Tree)
- é…ç½® Http è¯·æ±‚ï¼Œé¦–å…ˆæ˜¯åè®®(Protocol): `https` ï¼ŒæœåŠ¡åœ°å€(Server Name): `fanyi.baidu.com` ï¼Œè¯·æ±‚ç±»å‹: `POST` ï¼ŒPath: `/sug`
- æ·»åŠ ä¸ªè¯·æ±‚å‚æ•°(Parameters)ï¼Œç‚¹å‡»`Add`ï¼ŒName: `kw`ï¼ŒValue: `test`
- ç‚¹å‡»è¿è¡Œï¼Œæˆ–è€…ä½¿ç”¨å¿«æ·é”®`Ctrl+R`ï¼Œè¿è¡Œç»“æŸåœ¨ç»“æœæ ‘ä¸­æŸ¥çœ‹ç»“æœï¼Œçœ‹çœ‹æ˜¯å¦è¯·æ±‚æˆåŠŸ

### åœ¨å‘èµ·è¯·æ±‚å‰ï¼Œå¡«å……æ•°æ®

> é¦–å…ˆè¯´è¯´æˆ‘ä»¬è¦è¾¾åˆ°çš„é¢„æœŸï¼Œæˆ‘ä»¬è¦åœ¨è¯·æ±‚å‚æ•°ä¸­æ¸…ç†æ‰åŸæœ¬`kw`å‚æ•°çš„`test`å€¼ï¼Œå¡«å……ä¸Šæ–°çš„å‚æ•°å€¼`success`

> åœ¨å†™ä¸‹é¢çš„ä¸œè¥¿å‰ï¼Œå…ˆé™„ä¸Š[å®˜æ–¹æ–‡æ¡£](https://jmeter.apache.org/usermanual/component_reference.html#JSR223_PreProcessor)ï¼Œè¿™æ˜¯ JSR233 å‰ç½®å¤„ç†å™¨çš„æ–‡æ¡£ã€‚

- å…ˆåœ¨ Http è¯·æ±‚èŠ‚ç‚¹ä¸‹æ–°å»ºä¸ª JSR223 å‰ç½®å¤„ç†å™¨(JSR223 PreProcessor)ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥åœ¨åŒçº§èŠ‚ç‚¹å»º(ä¸è¿‡å¿…é¡»è¦åœ¨è¯·æ±‚èŠ‚ç‚¹å)ï¼ŒåŒçº§å»ºçš„è¯ï¼Œå¤„ç†å™¨çš„ä½œç”¨åŸŸå°±æ˜¯åŒçº§èŠ‚ç‚¹çš„æ‰€æœ‰è¯·æ±‚
- é€‰æ‹©è„šæœ¬ `groovy`
- ç¼–å†™è„šæœ¬

  ```groovy
  // è·å–è¯·æ±‚å‚æ•°
  def params = sampler.getArguments();
  // è·å–ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè¿™é‡Œæ’åºè·Ÿè¯·æ±‚èŠ‚ç‚¹çš„å‚æ•°é¡ºåºæŒ‚é’©
  def kw = params.getArgument(0);
  // èµ‹äºˆkwæ–°å€¼
  kw.setValue("success");
  ```

- è¿è¡Œæµ‹è¯•ä¸‹è¯·æ±‚å‚æ•°æ˜¯å¦å·²ç»æ›´æ”¹

å†™åˆ°è¿™é‡Œï¼Œæˆ‘çœŸçš„å¿ä¸ä½æƒ³åæ§½ä¸‹ï¼Œè¿™è¯·æ±‚å‚æ•°è—çš„å¤Ÿæ·±çš„å•Š ğŸ˜‘ å®˜æ–¹æ–‡æ¡£ä¹Ÿæ²¡å†™è¿™ç‚¹ï¼Œè¦ä¸æ˜¯çœ‹ API æ–‡æ¡£ï¼Œè¿˜çœŸå°±ä¸ä¸€å®šå‘ç°çš„äº† Argumentsã€‚å®˜æ–¹æ–‡æ¡£é‡Œ `Parameters`ã€`args`ã€`ctx`ã€`props`éƒ½è¯•äº†ï¼Œæ´»ç”Ÿç”Ÿè®©æˆ‘è¯•å‡ºæ¥çš„å•Š ğŸ˜¤ï¼ï¼ï¼

### åœ¨è¯·æ±‚ç»“æŸåï¼Œå¯¹è¿”å›çš„æ•°æ®è¿›è¡Œæ ¼å¼åŒ–å¤„ç†

> è¿”å›æ•°æ®çš„å¤„ç†ï¼Œä¸»è¦æ˜¯å¯¹è¿”å›çš„æ•°æ®è¿›è¡Œè§£ç ã€Json æ ¼å¼çš„ç¼©è¿›å±•ç¤º

> åç½®å¤„ç†å°±æ–¹ä¾¿çš„å¤šäº†ï¼Œåœ¨ JSR223 åç½®å¤„ç†å™¨(JSR223 PostProcessor)ä¸­ï¼Œæœ‰`prev`å‚æ•°å¯ç›´æ¥æ“ä½œç»“æœé›†

- åŒå‰ç½®å¤„ç†å™¨ä¸€æ ·ï¼Œå…ˆå»ºä¸ª JSR223 åç½®å¤„ç†å™¨èŠ‚ç‚¹ï¼Œä½œç”¨åŸŸåŒå‰ç½®å¤„ç†å™¨
- åŒæ ·ï¼Œè„šæœ¬é€‰æ‹©`groovy`
- ç¼–å†™è„šæœ¬

  ```groovy
  import groovy.json.JsonOutput;
  import org.apache.commons.lang3.StringEscapeUtils;
  // å­—ç¬¦ä¸²çš„å½¢å¼è¯»å–è¿”å›æ•°æ®
  def data = prev.getResponseDataAsString();
  // æ ¼å¼åŒ–jsonæ•°æ®
  def json = JsonOutput.prettyPrint(data);
  // å¯¹æ•°æ®è¿›è¡ŒUnicodeè½¬ä¸­æ–‡çš„è§£ç 
  def ret = StringEscapeUtils.unescapeJava(json);
  // æŠŠæˆ‘ä»¬è½¬æ¢åçš„æ•°æ®è®¾ç½®ä¸ºè¿”å›ç»“æœï¼Œç¼–ç è®¾ç½®ä¸ºUTF-8
  prev.setResponseData(ret, "UTF-8");
  ```

- è¿è¡Œæµ‹è¯•ç»“æœï¼Œå®Œç¾ç»“æŸï¼

è‡³æ­¤æ•´ä¸ªå‰ç½®åç½®çš„å¤„ç†å°±å®Œç¾äº†
